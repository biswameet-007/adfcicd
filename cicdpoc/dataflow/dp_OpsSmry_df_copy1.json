{
	"name": "dp_OpsSmry_df_copy1",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "OrgSiteRefRd",
						"type": "DatasetReference"
					},
					"name": "srcOpsSmryRd"
				},
				{
					"dataset": {
						"referenceName": "OrgSiteRefRd",
						"type": "DatasetReference"
					},
					"name": "ExistingRows"
				},
				{
					"dataset": {
						"referenceName": "OrgSiteRefRd",
						"type": "DatasetReference"
					},
					"name": "MaxSKey"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "sinkOperationSmryLd",
						"type": "DatasetReference"
					},
					"name": "sinkOpsSmryLdInsert"
				}
			],
			"transformations": [
				{
					"name": "dcOpsSmry"
				},
				{
					"name": "SKOpsSmry"
				},
				{
					"name": "dcWoAge"
				},
				{
					"name": "dcISbacklog"
				},
				{
					"name": "selOpsSmry"
				},
				{
					"name": "dcNewHashKey"
				},
				{
					"name": "exists"
				},
				{
					"name": "lookup"
				},
				{
					"name": "split"
				},
				{
					"name": "joinMaxSK"
				},
				{
					"name": "dcInsertItem"
				},
				{
					"name": "alterRowInsert"
				}
			],
			"scriptLines": [
				"source(output(",
				"          WORK_ORDER as string,",
				"          GOVT_WO as string,",
				"          ORGANIZATION_ID as integer,",
				"          SITE_ID as integer,",
				"          DESCRIPTION as string,",
				"          LOCATION as string,",
				"          ASSET as string,",
				"          REPORTED_DATE as timestamp,",
				"          PRIORITY as string,",
				"          STATUS as string,",
				"          WO_STATUS_CHANGEDATE as timestamp,",
				"          TARGET_START_DT as timestamp,",
				"          TARGET_FINISH_DT as timestamp,",
				"          WORK_GROUP as string,",
				"          WORK_TYPE as string,",
				"          PM_DUE_DT as timestamp,",
				"          SITE as string,",
				"          WORKTYPE_CM_PM as string,",
				"          TRADES as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: '\\n\\nSELECT WORK_ORDER,GOVT_WO,ORGANIZATION_ID,SITE_ID,DESCRIPTION,LOCATION, ASSET,\\nREPORTED_DATE,PRIORITY,STATUS,WO_STATUS_CHANGEDATE,TARGET_START_DT,TARGET_FINISH_DT,WORK_GROUP,WORK_TYPE,\\nPM_DUE_DT, SITE,WORKTYPE_CM_PM, TRADES\\nFROM(\\nSELECT WONUM AS WORK_ORDER,GOVTWONUM AS GOVT_WO,OPS.ORGANIZATION_ID AS ORGANIZATION_ID,OPS.SITE_ID AS SITE_ID,OPS.DESCRIPTION AS DESCRIPTION,OPS.LOCATION AS LOCATION,\\nISNULL(A.ASSETNUM,\\'NA\\') AS ASSET,\\nOPS.ASSET_ID AS ASSET_ID,\\nREPORTDATE AS REPORTED_DATE,WOPRIORITY AS PRIORITY,STATUS,WO_STATUS_CHANGEDATE,TARGSTARTDATE AS TARGET_START_DT,\\nTARGCOMPDATE AS TARGET_FINISH_DT,PERSON_GROUP AS WORK_GROUP,WORKTYPE AS WORK_TYPE,PMDUEDATE AS PM_DUE_DT,\\nS.SITE_NM AS SITE,OPS.WORKTYPE_CM_PM AS WORKTYPE_CM_PM,OPS.TRADES AS TRADES,\\nRANK() OVER(PARTITION BY WONUM,PARENT,OPS.SITE_ID ORDER BY WO_STATUS_CHANGEDATE DESC) RNK\\nFROM\\nMXMDW.OPERATION OPS INNER JOIN MXMDW.SITE S\\nON S.SITE_ID=OPS.SITE_ID\\nAND OPS.ISTASK = 0\\nLEFT OUTER JOIN MXMDW.ASSET A\\nON A.ASSET_ID=OPS.ASSET_ID\\n) TMP\\nWHERE RNK=1\\n\\n',",
				"     format: 'query',",
				"     staged: true) ~> srcOpsSmryRd",
				"source(output(",
				"          ExistOPERATION_SUMMARY_ID as integer,",
				"          ExistWORK_ORDER as string,",
				"          ExistSRC_TYPE_HASH_KEY as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT OPERATION_SUMMARY_ID AS ExistOPERATION_SUMMARY_ID,WORK_ORDER AS ExistWORK_ORDER,SRC_TYPE_HASH_KEY AS ExistSRC_TYPE_HASH_KEY FROM MXMDM.OPERATION_SUMMARY',",
				"     format: 'query',",
				"     staged: true) ~> ExistingRows",
				"source(output(",
				"          MAXKEY as integer",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT MAXKEY=ISNULL(MAX(OPERATION_SUMMARY_ID),0) FROM MXMDM.OPERATION_SUMMARY',",
				"     format: 'query',",
				"     staged: true) ~> MaxSKey",
				"srcOpsSmryRd derive(WO_OPEN_DT = REPORTED_DATE,",
				"          WO_DUE_DT = case(\r",
				"(PRIORITY == \"1\"), addDays(REPORTED_DATE,1),\r",
				"(PRIORITY == \"2\"), addDays(REPORTED_DATE,7),\r",
				"(PRIORITY == \"3\"), addDays(REPORTED_DATE,30),\r",
				"(PRIORITY == \"4\"), addDays(REPORTED_DATE,45),\r",
				"REPORTED_DATE\r",
				"),",
				"          WO_PRIORITY_THRESHOLD_DAYS = case(\r",
				"    (PRIORITY == \"1\"), 1,\r",
				"    (PRIORITY == \"2\"), 7,\r",
				"    (PRIORITY == \"3\"), 30,\r",
				"    (PRIORITY == \"4\"), 45,\r",
				"     0\r",
				"),",
				"          WO_CLOSE_DT = case\r",
				"(\r",
				"    (STATUS == 'CLOSE' || STATUS =='CAN' || STATUS == 'READY' || STATUS == 'COMP'), WO_STATUS_CHANGEDATE, currentTimestamp()\r",
				"    ),",
				"          PRIORITY = toInteger(PRIORITY),",
				"          PM_DUE_DT = iifNull(PM_DUE_DT, TARGET_START_DT, REPORTED_DATE)) ~> dcOpsSmry",
				"joinMaxSK keyGenerate(output(NEWOPERATION_SUMMARY_ID as long),",
				"     startAt: 1L,",
				"     stepValue: 1L) ~> SKOpsSmry",
				"dcOpsSmry derive(WO_CLOSE_DT = iifNull(WO_CLOSE_DT, currentTimestamp(), WO_CLOSE_DT),",
				"          WO_AGE = toInteger( (currentTimestamp() - REPORTED_DATE)/86400000 )) ~> dcWoAge",
				"dcWoAge derive(IS_BACKLOG = case\r",
				"(\r",
				"    (WO_CLOSE_DT > WO_DUE_DT), 'Yes',\r",
				"     (WO_CLOSE_DT <= WO_DUE_DT), 'No',\r",
				"     'Yes' ),",
				"          WO_AGE_SEGMENT = case\r",
				"(\r",
				"    (WO_AGE >=0 && WO_AGE <= 30), '0-30 Days',\r",
				"     (WO_AGE >=31 && WO_AGE <= 45), '31-45 Days',\r",
				"     (WO_AGE >=46 && WO_AGE <= 60), '46-60 Days',\r",
				"     (WO_AGE >=61 && WO_AGE <= 90), '61-90 Days',\r",
				"     'Above 90 Days' \r",
				"     )) ~> dcISbacklog",
				"dcNewHashKey select(mapColumn(",
				"          WORK_ORDER,",
				"          GOVT_WO,",
				"          DESCRIPTION,",
				"          LOCATION,",
				"          ASSET,",
				"          REPORTED_DATE,",
				"          PRIORITY,",
				"          STATUS,",
				"          TARGET_START_DT,",
				"          TARGET_FINISH_DT,",
				"          WORK_GROUP,",
				"          WORK_TYPE,",
				"          PM_DUE_DT,",
				"          SITE,",
				"          WORKTYPE_CM_PM,",
				"          TRADES,",
				"          WO_OPEN_DT,",
				"          WO_DUE_DT,",
				"          WO_PRIORITY_THRESHOLD_DAYS,",
				"          WO_CLOSE_DT,",
				"          WO_AGE,",
				"          IS_BACKLOG,",
				"          WO_AGE_SEGMENT,",
				"          SRC_TYPE_HASH_KEY",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> selOpsSmry",
				"dcISbacklog derive(SRC_TYPE_HASH_KEY = sha2(256,WORK_ORDER,WO_CLOSE_DT,WO_AGE,WO_AGE_SEGMENT,IS_BACKLOG)) ~> dcNewHashKey",
				"selOpsSmry, ExistingRows exists(SRC_TYPE_HASH_KEY == ExistSRC_TYPE_HASH_KEY,",
				"     negate:true,",
				"     broadcast: 'auto')~> exists",
				"exists, ExistingRows lookup(WORK_ORDER == ExistWORK_ORDER,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'auto')~> lookup",
				"lookup split(isNull(ExistOPERATION_SUMMARY_ID),",
				"     disjoint: false) ~> split@(NewItem, UpdateItem)",
				"split@NewItem, MaxSKey join(1==1,",
				"     joinType:'cross',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> joinMaxSK",
				"SKOpsSmry derive(NEWOPERATION_SUMMARY_ID = NEWOPERATION_SUMMARY_ID + MAXKEY,",
				"          SNAPSHOT_DT = currentTimestamp(),",
				"          EFFECTIVE_DT = currentTimestamp(),",
				"          ACTLABHRS = toDecimal(0.00)) ~> dcInsertItem",
				"dcInsertItem alterRow(insertIf(1==1)) ~> alterRowInsert",
				"alterRowInsert sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          OPERATION_SUMMARY_ID as integer,",
				"          WORK_ORDER as string,",
				"          GOVT_WO as string,",
				"          DESCRIPTION as string,",
				"          SITE_ID as integer,",
				"          LOCATION_ID as integer,",
				"          LOCATION as string,",
				"          ASSET as string,",
				"          REPORTED_DATE as timestamp,",
				"          PRIORITY as integer,",
				"          STATUS as string,",
				"          WO_STATUS_CHANGEDATE as timestamp,",
				"          TARGET_START_DT as timestamp,",
				"          TARGET_FINISH_DT as timestamp,",
				"          ACTLABHRS as decimal(18,9),",
				"          WORK_GROUP as string,",
				"          WORK_TYPE as string,",
				"          PM_DUE_DT as timestamp,",
				"          SITE as string,",
				"          WO_OPEN_DT as timestamp,",
				"          WO_DUE_DT as timestamp,",
				"          WO_PRIORITY_THRESHOLD_DAYS as integer,",
				"          WO_CLOSE_DT as timestamp,",
				"          WO_AGE as decimal(18,4),",
				"          WO_AGE_SEGMENT as string,",
				"          WORK_TYPE_CM_PM as string,",
				"          PERSON_GROUP_ID as integer,",
				"          IS_BACKLOG as string,",
				"          SNAPSHOT_DT as timestamp,",
				"          SRC_TYPE_HASH_KEY as string,",
				"          EFFECTIVE_DT as timestamp",
				"     ),",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     format: 'table',",
				"     staged: true,",
				"     allowCopyCommand: true,",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          OPERATION_SUMMARY_ID = NEWOPERATION_SUMMARY_ID,",
				"          WORK_ORDER,",
				"          GOVT_WO,",
				"          DESCRIPTION,",
				"          LOCATION,",
				"          ASSET,",
				"          REPORTED_DATE,",
				"          PRIORITY,",
				"          STATUS,",
				"          TARGET_START_DT,",
				"          TARGET_FINISH_DT,",
				"          ACTLABHRS,",
				"          WORK_GROUP,",
				"          WORK_TYPE,",
				"          WORK_TYPE_CM_PM = WORKTYPE_CM_PM,",
				"          PM_DUE_DT,",
				"          SITE,",
				"          WO_OPEN_DT,",
				"          WO_DUE_DT,",
				"          WO_PRIORITY_THRESHOLD_DAYS,",
				"          WO_CLOSE_DT,",
				"          IS_BACKLOG,",
				"          WO_AGE,",
				"          WO_AGE_SEGMENT,",
				"          TRADE = TRADES,",
				"          SRC_TYPE_HASH_KEY,",
				"          SNAPSHOT_DT,",
				"          EFFECTIVE_DT",
				"     )) ~> sinkOpsSmryLdInsert"
			]
		}
	}
}